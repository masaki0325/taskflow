# Local Code Review Command

ローカルの変更内容（git diff）をレビューしてください。プルリクエストを作成する前に、コードの品質やCLAUDE.md準拠をチェックできます。

## 実行方法

以下の手順で、現在のブランチの変更内容を詳細にレビューします。

## レビュー手順

1. **変更内容の確認**
   - `git diff main...HEAD` で現在のブランチとmainブランチの差分を取得
   - 変更されたファイルのリストを取得
   - 空の変更の場合は早期終了

2. **CLAUDE.mdファイルの特定**
   - ルートの `.claude/CLAUDE.md` を確認
   - 変更されたファイルのディレクトリに関連する CLAUDE.md を特定
   - バックエンドの変更なら `.claude/backend.md`
   - フロントエンドの変更なら `.claude/frontend.md`

3. **変更内容のサマリー作成**
   - Haiku エージェントを使用して変更内容の概要を作成
   - どのファイルが変更されたか
   - どのような機能追加・修正が行われたか

4. **並列レビュー実行**（5つのSonnetエージェントを並列起動）

   **Agent #1: CLAUDE.md 準拠チェック**
   - `.claude/CLAUDE.md`、`backend.md`、`frontend.md` の内容と照らし合わせ
   - コーディング規約に違反していないか
   - 命名規則、ディレクトリ構成、アーキテクチャパターンが正しいか

   **Agent #2: バグチェック**
   - 変更されたコードに明らかなバグがないか
   - ロジックエラー、nullチェック漏れ、型の不一致など
   - エッジケースの考慮漏れ

   **Agent #3: セキュリティチェック**
   - SQL injection、XSS、CSRF などの脆弱性がないか
   - パスワードの平文保存、機密情報のハードコードがないか
   - 認証・認可の実装が適切か

   **Agent #4: 履歴コンテキストチェック**
   - `git blame` と `git log` で変更箇所の履歴を確認
   - 過去のコミットメッセージから意図を理解
   - 以前の修正と矛盾していないか

   **Agent #5: コメント・ドキュメントチェック**
   - コード内のコメントで指示されている規約に従っているか
   - TODOコメントが適切に対処されているか
   - 複雑なロジックにドキュメントが追加されているか

5. **問題のスコアリング**
   - 各エージェントが見つけた問題について、Haikuエージェントで信頼度スコアを算出（0-100）
   - スコアリング基準：
     - **0点**: 誤検知、または既存の問題
     - **25点**: 可能性があるが確証がない、または明示的にCLAUDE.mdに記載がないスタイル問題
     - **50点**: 実際の問題だが重要度が低い、または実際には発生しにくい
     - **75点**: 重要な問題で実際に影響がある、またはCLAUDE.mdで明示的に禁止されている
     - **100点**: 確実に問題があり、頻繁に発生する重大なバグまたは脆弱性

6. **フィルタリング**
   - スコア80点以上の問題のみを抽出
   - 問題がない場合は「問題なし」と報告

7. **結果の報告**
   - 見つかった問題を優先度順に表示
   - ファイル名と行番号を明記
   - 具体的な修正案を提示
   - CLAUDE.mdの該当箇所を引用

## 出力フォーマット

### 問題が見つかった場合

```markdown
## ローカルコードレビュー結果

### 変更サマリー
- 変更ファイル数: X件
- 追加行数: +XXX
- 削除行数: -XXX

### 見つかった問題: N件

#### 1. [重大] 問題の簡潔な説明
**ファイル**: `path/to/file.py:123-125`

**詳細**:
CLAUDE.mdでは「...」と定義されていますが、このコードでは...

**修正案**:
```python
# 修正後のコード例
```

**参照**: `.claude/CLAUDE.md` の「セキュリティ要件」セクション

---

#### 2. [警告] 問題の簡潔な説明
...
```

### 問題がない場合

```markdown
## ローカルコードレビュー結果

### 変更サマリー
- 変更ファイル数: X件
- 追加行数: +XXX
- 削除行数: -XXX

### 結果
問題は見つかりませんでした。

以下の観点でレビューしました：
- CLAUDE.md 準拠チェック
- バグチェック
- セキュリティチェック
- コード履歴との整合性
- コメント・ドキュメントチェック

このままプルリクエストを作成しても問題ありません。
```

## 除外する問題（誤検知）

以下は報告しないでください：
- 既存のコードの問題（今回の変更で導入されていない問題）
- リンターや型チェッカーが検出する問題（別途CI/CDで検出される）
- 些細なスタイルの問題（CLAUDE.mdで明示的に禁止されていない限り）
- 意図的な変更（機能要件として必要な変更）
- コメントで明示的に無効化されている警告（例: `# type: ignore`）

## 使用例

```bash
# 現在のブランチの変更をレビュー
/local-review

# レビュー後、問題があれば修正してから再度レビュー
# 修正...
/local-review

# 問題なしと確認できたらプルリクエスト作成
gh pr create --title "..." --body "..."
```

## 注意事項

- このコマンドは変更内容のみをレビューします（全体のコード品質チェックではありません）
- コミット済みの変更のみが対象です（ステージングされていない変更は `git add` してからレビューしてください）
- レビューは補助的なものです。最終的な判断は開発者が行ってください
- ビルドやテストは実行しません（別途 `npm run build` や `pytest` で確認してください）
