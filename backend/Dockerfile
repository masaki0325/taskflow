# ============================================================
# Dockerイメージのベース指定
# ============================================================
# Python 3.12 の軽量版（slim）を使用
# slim版はフルバージョンより小さく、起動が速い
# 通常版: 約1GB、slim版: 約150MB
FROM python:3.12-slim

# ============================================================
# 作業ディレクトリの設定
# ============================================================
# コンテナ内の /app ディレクトリを作業ディレクトリに設定
# 以降のコマンドはこのディレクトリで実行される
WORKDIR /app

# ============================================================
# システム依存パッケージのインストール
# ============================================================
# apt-get: Debian/Ubuntuのパッケージマネージャー
RUN apt-get update && apt-get install -y \
    # gcc: C言語コンパイラ（一部のPythonパッケージのビルドに必要）
    gcc \
    # postgresql-client: PostgreSQLに接続するためのクライアントツール
    # psql コマンドやマイグレーションで使用
    postgresql-client \
    # インストール後、不要なキャッシュを削除してイメージサイズを削減
    && rm -rf /var/lib/apt/lists/*

# ============================================================
# Pythonパッケージのインストール
# ============================================================
# requirements.txt を先にコピー
# こうすることで、requirements.txt が変更されない限り
# この層（レイヤー）がキャッシュされ、ビルドが高速化される
COPY requirements.txt .

# pip install でPythonパッケージをインストール
# --no-cache-dir: pipのキャッシュを保存しない（イメージサイズ削減）
# -r requirements.txt: requirements.txt に記載されたパッケージを全てインストール
RUN pip install --no-cache-dir -r requirements.txt

# ============================================================
# アプリケーションコードのコピー
# ============================================================
# カレントディレクトリ（./backend）の全ファイルを /app にコピー
# .dockerignore に記載されたファイルは除外される
COPY . .

# ============================================================
# ポートの公開
# ============================================================
# コンテナの8000番ポートを外部に公開
# 実際のポートマッピングは docker-compose.yml で設定
EXPOSE 8000

# ============================================================
# コンテナ起動時のコマンド
# ============================================================
# CMD: コンテナが起動した時に実行されるデフォルトコマンド
# docker-compose.yml の command で上書き可能
# uvicorn: FastAPI を動かす ASGI サーバー
# app.main:app: app/main.py の app オブジェクトを起動
# --host 0.0.0.0: 全てのネットワークインターフェースでリッスン
# --port 8000: 8000番ポートで起動
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]

# ============================================================
# Dockerビルドの仕組み
# ============================================================
# Dockerは各命令（FROM, RUN, COPY など）ごとに「レイヤー」を作成
# レイヤーはキャッシュされるので、変更がない部分は再利用される
#
# ビルド順序の最適化:
# 1. ベースイメージ (FROM) ← ほぼ変更なし
# 2. システムパッケージ (RUN apt-get) ← たまに変更
# 3. requirements.txt (COPY + RUN pip) ← 時々変更
# 4. アプリコード (COPY .) ← 頻繁に変更
#
# この順序により、コード変更時も requirements.txt が
# 変更されていなければ、pip install をスキップできる
# ============================================================
